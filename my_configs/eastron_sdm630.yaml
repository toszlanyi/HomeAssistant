# ============================================================================
# EASTRON SDM630 - DEFINITION DER ENTITÄTEN
# ============================================================================

template:
  - sensor:
      # --- Wirkleistung Gesamt ---
      - name: "Netz Wirkleistung Gesamt"
        unique_id: eastron_grid_p_total
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_p_total') | float(0) }}"

      # --- Spannungen L1 (Schnitt & Min) ---
      - name: "Netz L1 Spannung"
        unique_id: eastron_grid_u_l1
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_l1') | float(0) }}"
      - name: "Netz L1 Spannung Min"
        unique_id: eastron_grid_u_min_l1
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_min_l1') | float(0) }}"
        icon: mdi:arrow-down-thick

      # --- Spannungen L2 (Schnitt & Min) ---
      - name: "Netz L2 Spannung"
        unique_id: eastron_grid_u_l2
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_l2') | float(0) }}"
      - name: "Netz L2 Spannung Min"
        unique_id: eastron_grid_u_min_l2
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_min_l2') | float(0) }}"
        icon: mdi:arrow-down-thick

      # --- Spannungen L3 (Schnitt & Min) ---
      - name: "Netz L3 Spannung"
        unique_id: eastron_grid_u_l3
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_l3') | float(0) }}"
      - name: "Netz L3 Spannung Min"
        unique_id: eastron_grid_u_min_l3
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_u_min_l3') | float(0) }}"
        icon: mdi:arrow-down-thick

      # --- Ströme L1, L2, L3 ---
      - name: "Netz L1 Strom"
        unique_id: eastron_grid_i_l1
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_i_l1') | float(0) }}"
      - name: "Netz L2 Strom"
        unique_id: eastron_grid_i_l2
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_i_l2') | float(0) }}"
      - name: "Netz L3 Strom"
        unique_id: eastron_grid_i_l3
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_i_l3') | float(0) }}"

      # --- Einzelleistungen pro Phase ---
      - name: "Netz L1 Leistung"
        unique_id: eastron_grid_p_l1
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_p_l1') | float(0) }}"
      - name: "Netz L2 Leistung"
        unique_id: eastron_grid_p_l2
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_p_l2') | float(0) }}"
      - name: "Netz L3 Leistung"
        unique_id: eastron_grid_p_l3
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_p_l3') | float(0) }}"

      # --- Frequenz ---
      - name: "Netz Frequenz"
        unique_id: eastron_grid_freq
        unit_of_measurement: "Hz"
        device_class: frequency
        state_class: measurement
        state: "{{ states('sensor.eastron_raw_freq') | float(0) }}"

      # --- Zählerstände (Energie-Dashboard) ---
      - name: "Netz Energie Bezug Gesamt"
        unique_id: eastron_grid_e_import
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        state: "{{ states('sensor.eastron_raw_e_import') | float(0) }}"
      - name: "Netz Energie Einspeisung Gesamt"
        unique_id: eastron_grid_e_export
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        state: "{{ states('sensor.eastron_raw_e_export') | float(0) }}"

      # --- Hilfswerte für Visualisierung ---
      - name: "Netz Bezug aktuell"
        unique_id: grid_import_watts
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set p = states('sensor.eastron_raw_p_total') | float(0) %}
          {{ [p, 0] | max }}
      - name: "Netz Einspeisung aktuell"
        unique_id: grid_export_watts
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set p = states('sensor.eastron_raw_p_total') | float(0) %}
          {{ [p * -1, 0] | max }}
